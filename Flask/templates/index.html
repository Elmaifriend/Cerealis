<!DOCTYPE html>
<html>
<head>
    <title>Demo WebSocket</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Vista del dron</h1>
    <img id="video" width="320" src="/static/video.jpg" />
    <br>
    <button onclick="startDemo()">Iniciar demo</button>
    <br><br>

    <div>
        <button id="forward">Enfrente</button>
        <button id="backward">Atr√°s</button>
        <button id="left">Izquierda</button>
        <button id="right">Derecha</button>
    </div>

    <script>
        const socket = io("http://" + location.hostname + ":5000");
        const video = document.getElementById("video");

        let lastFrameTime = Date.now();
        const TIMEOUT_MS = 1000;
        const fallbackImage = "/static/video.jpg";
        let currentBlobUrl = null;

        socket.on('connect', () => {
            console.log("‚úÖ Conectado al servidor WebSocket");
        });

        socket.on('message', (event) => {
            console.log("üì© Mensaje del servidor:", event);
            if (event === "start_demo") {
                alert("¬°Comenzando demo de vuelo!");
            }
        });

        socket.on('image', (data) => {
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
            }
            const blob = new Blob([data], { type: 'image/png' });
            currentBlobUrl = URL.createObjectURL(blob);
            video.src = currentBlobUrl;
            lastFrameTime = Date.now();
        });

        function startDemo() {
            socket.emit("message", "start_demo");
        }

        // Control en tiempo real (presionar/sostener bot√≥n)
        const buttons = {
            forward: "move_forward",
            backward: "move_backward",
            left: "move_left",
            right: "move_right"
        };

        for (const [id, command] of Object.entries(buttons)) {
            const btn = document.getElementById(id);

            // Escritorio
            btn.addEventListener("mousedown", () => {
                socket.emit("drone_command", { action: command, state: "start" });
            });
            btn.addEventListener("mouseup", () => {
                socket.emit("drone_command", { action: command, state: "stop" });
            });
            btn.addEventListener("mouseleave", () => {
                socket.emit("drone_command", { action: command, state: "stop" });
            });

            // M√≥vil
            btn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                socket.emit("drone_command", { action: command, state: "start" });
            }, { passive: false });

            btn.addEventListener("touchend", (e) => {
                e.preventDefault();
                socket.emit("drone_command", { action: command, state: "stop" });
            });

            btn.addEventListener("touchcancel", (e) => {
                e.preventDefault();
                socket.emit("drone_command", { action: command, state: "stop" });
            });
        }

        // Fallback si no llega imagen
        setInterval(() => {
            if (Date.now() - lastFrameTime > TIMEOUT_MS) {
                if (video.src !== location.origin + fallbackImage) {
                    if (currentBlobUrl) {
                        URL.revokeObjectURL(currentBlobUrl);
                        currentBlobUrl = null;
                    }
                    video.src = fallbackImage;
                }
            }
        }, 500);
    </script>
</body>
</html>
